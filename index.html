<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi Siswa</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @media print {
      .no-print { display: none !important; }
      .print-area { padding: 0 !important; box-shadow: none !important; background: white !important; }
      body { background: white !important; }
    }
    .seg-option { transition: background-color .15s, color .15s, transform .15s; }
    .seg-option:active { transform: translateY(1px) }
    .status-dot { width: 10px; height: 10px; border-radius: 9999px; display: inline-block; margin-right: 6px }
  </style>

</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-600 via-sky-500 to-cyan-400 text-slate-900">

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
   
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      	<div>
        <h1 class="text-3xl font-extrabold text-white drop-shadow-sm">Absensi Siswa Formal</h1>
        <p class="text-white/90 mt-1">SMP Islam Bakti Agung dan SMKS Al Akhyar</p>
    	  </div>

      <div class="flex items-center gap-3">
        <button id="addStudentBtn" class="no-print inline-flex items-center gap-2 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-xl shadow-sm transition focus:outline-none focus:ring-2 focus:ring-white/50">
          <svg xmlns="https://mohsyamsih.blogspot.com/" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/></svg>
          Tambah Siswa
        </button>
        
        <button id="printBtn" class="no-print inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl shadow-sm backdrop-blur-sm transition focus:outline-none focus:ring-2 focus:ring-white/50">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6v-8z"/></svg>
          Cetak
        </button>

        <!-- CSV export button removed per request -->

        <button id="exportExcelBtn" class="no-print inline-flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl shadow-sm transition focus:outline-none focus:ring-2 focus:ring-white/50">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v12a2 2 0 002 2h9a1 1 0 100-2H4V6h9a1 1 0 100-2H4zm15 0h-4a1 1 0 100 2h3v3a1 1 0 102 0V6h3a1 1 0 100-2h-4zm-6 6H6a1 1 0 000 2h7a1 1 0 100-2zm7 3a1 1 0 00-1 1v.586l-2.293-2.293a1 1 0 10-1.414 1.414L17.586 16H17a1 1 0 100 2h3a1 1 0 001-1v-3a1 1 0 00-1-1z"/></svg>
          Ekspor
        </button>
        <button id="importExcelBtn" class="no-print inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl shadow-sm backdrop-blur-sm transition focus:outline-none focus:ring-2 focus:ring-white/50">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm8 3H4a2 2 0 01-2-2V7h2v10h16V7h2v10a2 2 0 01-2 2z"/></svg>
          Impor
        </button>

        <button id="downloadTemplateBtn" class="no-print inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-xl shadow-sm backdrop-blur-sm transition focus:outline-none focus:ring-2 focus:ring-white/50">
          Template
        </button>
        <input id="importFile" type="file" accept=".csv,.xls,.xlsx" class="hidden" />
      </div>
    </header>

    <!-- Controls -->
    <section class="no-print mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white/20 backdrop-blur-md rounded-2xl p-4 text-white shadow-sm">
        <label class="block text-sm mb-1">Pilih Kelas</label>
        <select id="classSelect" class="w-full rounded-xl text-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-white/60"></select>
      </div>
      <div class="bg-white/20 backdrop-blur-md rounded-2xl p-4 text-white shadow-sm">
        <label class="block text-sm mb-1">Tanggal</label>
        <input id="dateInput" type="date" class="w-full rounded-xl text-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-white/60" />
      </div>
      <!-- Nama Guru removed per request -->
      <div class="bg-white/20 backdrop-blur-md rounded-2xl p-4 text-white shadow-sm flex items-end gap-3">
        <button id="markAllPresent" class="w-full bg-emerald-400 hover:bg-emerald-500 text-white font-medium px-4 py-2 rounded-xl transition">Tandai Semua Hadir</button>
        <button id="markAllAlpha" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-medium px-4 py-2 rounded-xl transition">Tandai Semua Alfa</button>
        <button id="clearDay" class="w-full bg-white/20 hover:bg-white/30 text-white font-medium px-4 py-2 rounded-xl transition">Hapus Semua Tanda</button>
      </div>
    </section>

    <!-- Tabs -->
    <nav class="no-print mt-6 bg-white/20 backdrop-blur-md rounded-2xl p-1 text-white shadow-sm inline-flex">
      <button data-tab="harian" class="tab-btn active px-4 py-2 rounded-xl font-medium">Harian</button>
      <button data-tab="mingguan" class="tab-btn px-4 py-2 rounded-xl font-medium">Mingguan</button>
      <button data-tab="bulanan" class="tab-btn px-4 py-2 rounded-xl font-medium">Bulanan</button>
      <button data-tab="Tahunan" class="tab-btn px-4 py-2 rounded-xl font-medium">Tahunan</button>
    </nav>

    <!-- Content -->
    <main class="mt-4 space-y-6">
      <!-- Daily -->
      <section id="tab-harian" class="print-area bg-white rounded-2xl shadow-xl p-4 sm:p-6">
        <div class="flex items-center justify-between gap-3 mb-4">
          <div>
            <h2 class="text-xl font-bold text-slate-800">Absensi Harian</h2>
          </div>
          <div id="dayInfo" class="text-sm text-slate-500"></div>
        </div>
        <div id="dailyList" class="space-y-3"></div>
        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button id="saveDaily" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-semibold shadow-sm transition">Simpan Absensi</button>
          <div id="saveStatus" class="hidden items-center gap-2 text-emerald-600 font-medium">
            <span class="inline-flex w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse"></span>
            Absen Tersimpan
          </div>
        </div>
        <p class="text-xs text-slate-500 mt-6">Catatan: Data disimpan di perangkat Anda (local). Tidak ada koneksi ke server. Ekspor/Impor mendukung .csv dan .xls (bukan .xlsx).</p>
      </section>

      <!-- Weekly -->
      <section id="tab-mingguan" class="hidden print-area bg-white rounded-2xl shadow-xl p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-4">
          <div>
            <h2 class="text-xl font-bold text-slate-800">Rekap Mingguan</h2>
            <p id="weekRangeText" class="text-sm text-slate-500 mt-1">—</p>
          </div>
          <div class="no-print flex flex-wrap items-center gap-3">
            <input id="weekDate" type="date" class="rounded-xl text-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
            <select id="weekClass" class="rounded-xl text-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200"></select>
            <label class="inline-flex items-center gap-2 bg-white/70 text-slate-700 px-3 py-2 rounded-xl">
              <input id="weekAllToggle" type="checkbox" class="accent-indigo-600">
              <span class="text-sm font-medium">Semua Kelas</span>
            </label>
          </div>
        </div>
        <div id="weeklyTableWrap" class="overflow-auto rounded-xl border border-slate-200"></div>
        <div id="weeklyAllWrap" class="hidden overflow-auto rounded-xl border border-slate-200"></div>
        <p class="text-xs text-slate-500 mt-6">Dihitung dari hari yang memiliki data absensi pada minggu tersebut. Mode "Semua Kelas" diurutkan berdasarkan asrama.</p>
      </section>

      <!-- Monthly -->
      <section id="tab-bulanan" class="hidden print-area bg-white rounded-2xl shadow-xl p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-4">
          <div>
            <h2 class="text-xl font-bold text-slate-800">Rekap Bulanan</h2>
            <p id="monthRangeText" class="text-sm text-slate-500 mt-1">—</p>
          </div>
          <div class="no-print flex items-center gap-3">
            <input id="monthInput" type="month" class="rounded-xl text-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
            <select id="monthClass" class="rounded-xl text-slate-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200"></select>
          </div>
        </div>
        <div id="monthlyTableWrap" class="overflow-auto rounded-xl border border-slate-200"></div>
        <p class="text-xs text-slate-500 mt-3">Persentase = Hadir / total hari dengan data pada bulan tersebut.</p>
      </section>
    </main>
  </div>

  <!-- Import Preview Modal -->
  <div id="importModal" class="hidden fixed inset-0 z-50 items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white w-[95%] max-w-3xl rounded-2xl shadow-2xl overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Pratinjau Impor Siswa</h3>
        <button id="closeModal" class="text-slate-500 hover:text-slate-700">✕</button>
      </div>
      <div class="p-5 max-h-[70vh] overflow-auto">
        <div id="importSummary" class="mb-3 text-sm text-slate-600"></div>
        <div id="importErrors" class="hidden mb-3 p-3 rounded-xl bg-rose-50 text-rose-700 text-sm"></div>
        <div class="overflow-auto rounded-xl border border-slate-200">
          <table class="min-w-[720px] w-full text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="text-left px-3 py-2">Kelas</th>
                <th class="text-left px-3 py-2">Nama</th>
                <th class="text-left px-3 py-2">Asrama</th>
                <th class="text-left px-3 py-2">ID</th>
                <th class="text-left px-3 py-2">Status</th>
              </tr>
            </thead>
            <tbody id="importTableBody"></tbody>
          </table>
        </div>
        <p id="importMoreNote" class="hidden mt-2 text-xs text-slate-500"></p>
      </div>
      <div class="px-5 py-4 border-t border-slate-200 flex items-center justify-end gap-3">
        <button id="cancelImport" class="px-4 py-2 rounded-xl bg-white text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50">Batal</button>
        <button id="confirmImport" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Impor Sekarang</button>
      </div>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div id="addStudentModal" class="hidden fixed inset-0 z-50 items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white w-[95%] max-w-lg rounded-2xl shadow-2xl overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Tambah Siswa</h3>
        <button id="closeAddModal" class="text-slate-500 hover:text-slate-700">✕</button>
      </div>
      <form id="addStudentForm" class="p-5 space-y-4">
        <div>
          <label class="block text-sm text-slate-700 mb-1">Kelas</label>
          <select id="addClass" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200"></select>
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">Nama</label>
          <input id="addName" type="text" placeholder="Nama lengkap" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" required />
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">Asrama</label>
          <input id="addDorm" type="text" placeholder="Asrama (opsional)" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">ID Siswa (opsional)</label>
          <input id="addId" type="text" placeholder="Jika kosong akan dibuat otomatis" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-slate-200">
          <button type="button" id="cancelAdd" class="px-4 py-2 rounded-xl bg-white text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50">Batal</button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div id="editStudentModal" class="hidden fixed inset-0 z-50 items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative bg-white w-[95%] max-w-lg rounded-2xl shadow-2xl overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Edit Siswa</h3>
        <button id="closeEditModal" class="text-slate-500 hover:text-slate-700">✕</button>
      </div>
      <form id="editStudentForm" class="p-5 space-y-4">
        <input type="hidden" id="editOriginalId" />
        <input type="hidden" id="editOriginalClass" />
        <div>
          <label class="block text-sm text-slate-700 mb-1">Kelas</label>
          <select id="editClass" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200"></select>
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">Nama</label>
          <input id="editName" type="text" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" required />
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">Asrama</label>
          <input id="editDorm" type="text" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">ID Siswa</label>
          <input id="editId" type="text" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-200" />
        </div>
        <div class="flex flex-wrap items-center justify-between gap-3 pt-2 border-t border-slate-200">
          <button type="button" id="deleteStudent" class="px-4 py-2 rounded-xl bg-rose-100 text-rose-700 hover:bg-rose-200">Hapus</button>
          <div class="flex items-center gap-3">
            <button type="button" id="cancelEdit" class="px-4 py-2 rounded-xl bg-white text-slate-700 ring-1 ring-slate-200 hover:bg-slate-50">Batal</button>
            <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Simpan Perubahan</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ----- Data Setup -----
    const CLASS_NAMES = [
      "KELAS 7A","KELAS 7B",
      "KELAS 8A","KELAS 8B",
      "KELAS 9A","KELAS 9B",
      "KELAS 10 TKJ 1","KELAS 10 TKJ 2","KELAS 10 TSM",
      "KELAS 11 TKJ 1","KELAS 11 TKJ 2","KELAS 11 TSM",
      "KELAS 12 TKJ 1","KELAS 12 TKJ 2","KELAS 12 TSM"
    ];
    const CLASS_MAP = Object.fromEntries(CLASS_NAMES.map(n => [n.toUpperCase().replace(/\s+/g,' ').trim(), n]));
    // Terlambat dihilangkan dari tombol harian
    const STATUS = ["HADIR","IZIN","SAKIT","ALFA"];
    const STATUS_LABEL = { HADIR:"Hadir", IZIN:"Izin", SAKIT:"Sakit", ALFA:"Alfa" };
    const STATUS_COLOR = {
      HADIR:"bg-emerald-100 text-emerald-700 ring-emerald-200",
      IZIN:"bg-sky-100 text-sky-700 ring-sky-200",
      SAKIT:"bg-orange-100 text-orange-700 ring-orange-200",
      ALFA:"bg-rose-100 text-rose-700 ring-rose-200"
    };
    const DOT_COLOR = { HADIR:"#10b981", TERLAMBAT:"#f59e0b", IZIN:"#0ea5e9", SAKIT:"#fb923c", ALFA:"#f43f5e" };

    // Sample data
    const DEFAULT_STUDENTS = {
      "KELAS 7A": [
        { id: "7A-1", name: "Andi Pratama", dorm: "Asrama A" },
        { id: "7A-2", name: "Budi Santoso", dorm: "Asrama B" },
      ],
      "KELAS 7B": [
        { id: "7B-1", name: "Citra Lestari", dorm: "Asrama C" },
        { id: "7B-2", name: "Dewi Anindya", dorm: "Asrama A" },
      ],
      "KELAS 8A": [
        { id: "8A-1", name: "Eka Saputra", dorm: "Asrama B" },
        { id: "8A-2", name: "Fajar Nugroho", dorm: "Asrama C" },
      ],
      "KELAS 8B": [
        { id: "8B-1", name: "Gita Maulida", dorm: "Asrama A" },
        { id: "8B-2", name: "Hadi Wijaya", dorm: "Asrama B" },
      ],
      "KELAS 9A": [
        { id: "9A-1", name: "Indah Puspita", dorm: "Asrama C" },
        { id: "9A-2", name: "Joko Prakoso", dorm: "Asrama A" },
      ],
      "KELAS 9B": [
        { id: "9B-1", name: "Kirana Putri", dorm: "Asrama B" },
        { id: "9B-2", name: "Lukman Hakim", dorm: "Asrama C" },
      ],
      "KELAS 10 TKJ PUTRA": [
        { id: "10TKJ-P-1", name: "Maya Sari", dorm: "Asrama A" },
        { id: "10TKJ-P-2", name: "Nurul Aini", dorm: "Asrama B" },
      ],
      "KELAS 10 TKJ PUTRI": [
        { id: "10TKJ-Pr-1", name: "Oka Ardana", dorm: "Asrama C" },
        { id: "10TKJ-Pr-2", name: "Putra Mahendra", dorm: "Asrama A" },
      ],
      "KELAS 10 TSM": [
        { id: "10TSM-1", name: "Qori Amalia", dorm: "Asrama B" },
        { id: "10TSM-2", name: "Rama Dwi", dorm: "Asrama C" },
      ],
      "KELAS 11 TKJ PUTRA": [
        { id: "11TKJ-P-1", name: "Salsa Bela", dorm: "Asrama A" },
        { id: "11TKJ-P-2", name: "Tomo Widodo", dorm: "Asrama B" },
      ],
      "KELAS 11 TKJ PUTRI": [
        { id: "11TKJ-Pr-1", name: "Uli Rahma", dorm: "Asrama C" },
        { id: "11TKJ-Pr-2", name: "Vino Saputra", dorm: "Asrama A" },
      ],
      "KELAS 11 TSM": [
        { id: "11TSM-1", name: "Wulan Anggra", dorm: "Asrama B" },
        { id: "11TSM-2", name: "Yoga Pratama", dorm: "Asrama C" },
      ],
      "KELAS 12 TKJ PUTRA": [
        { id: "12TKJ-P-1", name: "Zaky Firmansyah", dorm: "Asrama A" },
        { id: "12TKJ-P-2", name: "Alya Nabila", dorm: "Asrama B" },
      ],
      "KELAS 12 TKJ PUTRI": [
        { id: "12TKJ-Pr-1", name: "Bagas Seto", dorm: "Asrama C" },
        { id: "12TKJ-Pr-2", name: "Cindy Oktav", dorm: "Asrama A" },
      ],
      "KELAS 12 TSM": [
        { id: "12TSM-1", name: "Dimas Raditya", dorm: "Asrama B" },
        { id: "12TSM-2", name: "Elisa Permata", dorm: "Asrama C" },
      ],
    };

    const LS_KEY = "attendanceData_v1";
    const STUDENTS_LS_KEY = "studentsData_v2";

    // Helpers
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const formatDateLong = (d) => d.toLocaleDateString("id-ID", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
    const ymd = (d) => { const z = (n) => String(n).padStart(2, "0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; };
    const parseYMD = (s) => { const [y, m, d] = s.split("-").map(Number); return new Date(y, m - 1, d); };
    function loadStore() { try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : {}; } catch { return {}; } }
    function saveStore(data) { localStorage.setItem(LS_KEY, JSON.stringify(data)); }
    function loadStudentsData() { try { const raw = localStorage.getItem(STUDENTS_LS_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; } }
    function saveStudentsData(data) { localStorage.setItem(STUDENTS_LS_KEY, JSON.stringify(data)); }
    function getWeekRange(anyDate) { const d = new Date(anyDate); const day = (d.getDay() + 6) % 7; const start = new Date(d); start.setDate(d.getDate() - day); const end = new Date(start); end.setDate(start.getDate() + 6); start.setHours(0,0,0,0); end.setHours(23,59,59,999); return { start, end }; }
    function getMonthRange(ym) { const [year, month] = ym.split("-").map(Number); const start = new Date(year, month - 1, 1); const end = new Date(year, month, 0); start.setHours(0,0,0,0); end.setHours(23,59,59,999); return { start, end }; }
    function eachDateInRange(start, end) { const dates = []; const cur = new Date(start); while (cur <= end) { dates.push(ymd(cur)); cur.setDate(cur.getDate() + 1); } return dates; }
    function showToast(msg, type="success") { const bg = type === "error" ? "bg-rose-600" : "bg-emerald-600"; const el = document.createElement("div"); el.className = `fixed top-4 right-4 z-50 ${bg} text-white px-4 py-2 rounded-xl shadow-lg`; el.textContent = msg; document.body.appendChild(el); setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity .3s"; }, 2000); setTimeout(() => { el.remove(); }, 2400); }

    // In-memory students
    let STUDENTS = loadStudentsData() || DEFAULT_STUDENTS;

    // UI refs
    const classSelect = $("#classSelect");
    const dateInput = $("#dateInput");
    const dailyList = $("#dailyList");
    const dayInfo = $("#dayInfo");
    const weekDate = $("#weekDate");
    const weekClass = $("#weekClass");
    const monthInput = $("#monthInput");
    const monthClass = $("#monthClass");
    const tabs = $$(".tab-btn");
    const importBtn = $("#importExcelBtn");
    const importFile = $("#importFile");
    const downloadTemplateBtn = $("#downloadTemplateBtn");
    const addStudentBtn = $("#addStudentBtn");

    // Modal refs
    const importModal = $("#importModal");
    const importTableBody = $("#importTableBody");
    const importSummary = $("#importSummary");
    const importErrors = $("#importErrors");
    const importMoreNote = $("#importMoreNote");
    const closeModalBtn = $("#closeModal");
    const cancelImportBtn = $("#cancelImport");
    const confirmImportBtn = $("#confirmImport");
    let _previewRows = [];

    function populateClassSelects() {
      [classSelect, weekClass, monthClass].forEach(sel => {
        sel.innerHTML = "";
        CLASS_NAMES.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c;
          sel.appendChild(opt);
        });
      });
    }

    function defaultInit() {
      populateClassSelects();
      const today = new Date();
      dateInput.value = ymd(today);
      weekDate.value = ymd(today);
      monthInput.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}`;
      classSelect.value = CLASS_NAMES[0];
      weekClass.value = CLASS_NAMES[0];
      monthClass.value = CLASS_NAMES[0];
      renderDaily();
      renderWeekly();
      renderMonthly();
      updateTabActive("harian");
    }

    // ----- Daily Rendering -----
    function renderDaily() {
      const cls = classSelect.value;
      const d = parseYMD(dateInput.value);
      dayInfo.textContent = formatDateLong(d);
      const store = loadStore();
      const dayKey = ymd(d);
      const dayData = (store[dayKey] && store[dayKey][cls]) || {};
      const students = STUDENTS[cls] || [];

      dailyList.innerHTML = "";
      students.forEach(stu => {
        const current = dayData[stu.id]?.status || "";
        const row = document.createElement("div");
        row.className = "flex flex-col sm:flex-row sm:items-center justify-between gap-3 bg-slate-50 rounded-xl p-3 ring-1 ring-slate-200";
        row.dataset.studentId = stu.id;

        const left = document.createElement("div");
        left.className = "flex items-center gap-3";
        const avatar = document.createElement("div");
        avatar.className = "w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-sky-400 text-white flex items-center justify-center font-bold shadow";
        avatar.textContent = stu.name.split(" ").map(w => w[0]).slice(0,2).join("");
        const name = document.createElement("div");
        name.innerHTML = `<div class="font-semibold text-slate-800">${stu.name}</div><div class="text-xs text-slate-500">${cls} • ${stu.dorm || 'Asrama -'}</div>`;
        left.appendChild(avatar);
        left.appendChild(name);

        const right = document.createElement("div");
        right.className = "grid grid-cols-2 sm:flex sm:flex-wrap sm:justify-end gap-2";
        STATUS.forEach(st => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = `seg-option px-3 py-2 rounded-lg ring-1 ${current === st ? STATUS_COLOR[st] : "bg-white text-slate-700 hover:bg-slate-50 ring-slate-200"}`;
          btn.textContent = STATUS_LABEL[st];
          btn.dataset.status = st;
          btn.addEventListener("click", () => {
            $$(".seg-option", right).forEach(b => { b.className = `seg-option px-3 py-2 rounded-lg ring-1 bg-white text-slate-700 hover:bg-slate-50 ring-slate-200`; });
            btn.className = `seg-option px-3 py-2 rounded-lg ring-1 ${STATUS_COLOR[st]}`;
            row.dataset.selected = st;
          });
          if (current === st) row.dataset.selected = st;
          right.appendChild(btn);
        });

        // Edit button per siswa
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "px-3 py-2 rounded-lg ring-1 ring-slate-200 bg-white text-indigo-600 hover:bg-indigo-50";
        editBtn.innerHTML = `<span class="hidden sm:inline">Edit</span><span class="sm:hidden">✎</span>`;
        editBtn.addEventListener("click", () => openEditModal(cls, stu));
        right.appendChild(editBtn);

        // Hapus button per siswa
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "px-3 py-2 rounded-lg ring-1 ring-rose-200 bg-white text-rose-600 hover:bg-rose-50";
        delBtn.innerHTML = `<span class="hidden sm:inline">Hapus</span><span class="sm:hidden">🗑️</span>`;
        delBtn.addEventListener("click", () => {
          const ok = confirm(`Hapus ${stu.name}?`);
          if (!ok) return;
          const list = STUDENTS[cls] || [];
          STUDENTS[cls] = list.filter(s => s.id !== stu.id);
          saveStudentsData(STUDENTS);
          renderDaily(); renderWeekly(); renderMonthly();
          showToast('Siswa dihapus');
        });
        right.appendChild(delBtn);

        row.appendChild(left);
        row.appendChild(right);
        dailyList.appendChild(row);
      });
    }

    function saveDaily() {
      const cls = classSelect.value;
      const dayKey = dateInput.value;
      const store = loadStore();
      store[dayKey] = store[dayKey] || {};
      store[dayKey][cls] = store[dayKey][cls] || {};

      $$("#dailyList > div").forEach(row => {
        const sid = row.dataset.studentId;
        const st = row.dataset.selected || null;
        if (st) { store[dayKey][cls][sid] = { status: st }; }
        else { if (store[dayKey][cls][sid]) delete store[dayKey][cls][sid]; }
      });
      const keys = Object.keys(store[dayKey][cls]);
      if (keys.length === 0) delete store[dayKey][cls];
      if (store[dayKey] && Object.keys(store[dayKey]).length === 0) delete store[dayKey];

      saveStore(store);
      const s = $("#saveStatus"); s.classList.remove("hidden"); setTimeout(() => s.classList.add("hidden"), 1500);
      renderWeekly(); renderMonthly();
    }

    function markAll(status) {
      $$("#dailyList > div").forEach(row => {
        const group = row.querySelectorAll(".seg-option");
        group.forEach(b => {
          b.className = `seg-option px-3 py-2 rounded-lg ring-1 bg-white text-slate-700 hover:bg-slate-50 ring-slate-200`;
          if (b.dataset.status === status) {
            b.className = `seg-option px-3 py-2 rounded-lg ring-1 ${STATUS_COLOR[status]}`;
            row.dataset.selected = status;
          }
        });
      });
    }
    function clearDay() {
      $$("#dailyList > div").forEach(row => {
        row.dataset.selected = "";
        row.querySelectorAll(".seg-option").forEach(b => { b.className = `seg-option px-3 py-2 rounded-lg ring-1 bg-white text-slate-700 hover:bg-slate-50 ring-slate-200`; });
      });
    }

    // ----- Aggregation -----
    function aggregateRange(cls, start, end) {
      const store = loadStore();
      const dates = eachDateInRange(start, end);
      const students = STUDENTS[cls] || [];
      const counts = {};
      students.forEach(s => { counts[s.id] = { HADIR:0, TERLAMBAT:0, IZIN:0, SAKIT:0, ALFA:0, totalDays:0 }; });

      const daysWithData = new Set();
      dates.forEach(dayKey => {
        const dayData = store[dayKey]?.[cls];
        if (dayData) {
          daysWithData.add(dayKey);
          students.forEach(s => {
            const st = dayData[s.id]?.status;
            if (st && counts[s.id][st] !== undefined) counts[s.id][st] += 1;
          });
        }
      });
      const totalActiveDays = daysWithData.size;
      students.forEach(s => counts[s.id].totalDays = totalActiveDays);
      return { counts, totalActiveDays, students };
    }

    function buildSummaryTable({ counts, totalActiveDays, students }, captionText) {
      const wrap = document.createElement("div");
      const table = document.createElement("table");
      table.className = "min-w-[720px] w-full text-sm text-slate-700";
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr class="bg-slate-50 text-slate-600">
          <th class="text-left px-4 py-3 font-semibold">Siswa</th>
          <th class="px-4 py-3 font-semibold">Asrama</th>
          <th class="px-4 py-3 font-semibold">Hadir</th>
          <th class="px-4 py-3 font-semibold">Izin</th>
          <th class="px-4 py-3 font-semibold">Sakit</th>
          <th class="px-4 py-3 font-semibold">Alfa</th>
          <th class="px-4 py-3 font-semibold">Persentase</th>
        </tr>`;
      const tbody = document.createElement("tbody");

      students.forEach(s => {
        const c = counts[s.id];
        const hadir = c.HADIR; // Terlambat tidak ikut
        const pct = c.totalDays ? Math.round((hadir / c.totalDays) * 100) : 0;
        const tr = document.createElement("tr");
        tr.className = "border-t border-slate-200";
        tr.innerHTML = `
          <td class="px-4 py-3 font-medium">${s.name}</td>
          <td class="px-4 py-3">${s.dorm || '-'}</td>
          <td class="px-4 py-3"><span class="status-dot" style="background:${DOT_COLOR.HADIR}"></span>${c.HADIR}</td>
          <td class="px-4 py-3"><span class="status-dot" style="background:${DOT_COLOR.IZIN}"></span>${c.IZIN}</td>
          <td class="px-4 py-3"><span class="status-dot" style="background:${DOT_COLOR.SAKIT}"></span>${c.SAKIT}</td>
          <td class="px-4 py-3"><span class="status-dot" style="background:${DOT_COLOR.ALFA}"></span>${c.ALFA}</td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                <div class="h-full bg-emerald-500" style="width:${pct}%"></div>
              </div>
              <span class="tabular-nums">${pct}%</span>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      const totals = { HADIR:0, IZIN:0, SAKIT:0, ALFA:0 };
      students.forEach(s => { totals.HADIR += counts[s.id].HADIR; totals.IZIN += counts[s.id].IZIN; totals.SAKIT += counts[s.id].SAKIT; totals.ALFA += counts[s.id].ALFA; });
      const totalRow = document.createElement("tr");
      totalRow.className = "border-t-2 border-slate-300 bg-slate-50 font-semibold";
      const classPct = (() => {
        const sumPresent = totals.HADIR;
        const denom = students.reduce((acc, s) => acc + counts[s.id].totalDays, 0) || 0;
        return denom ? Math.round((sumPresent / denom) * 100) : 0;
      })();
      totalRow.innerHTML = `
        <td class="px-4 py-3">Total</td>
        <td class="px-4 py-3">${totals.HADIR}</td>
        <td class="px-4 py-3">${totals.IZIN}</td>
        <td class="px-4 py-3">${totals.SAKIT}</td>
        <td class="px-4 py-3">${totals.ALFA}</td>
        <td class="px-4 py-3">${classPct}%</td>`;
      const caption = document.createElement("div");
      caption.className = "px-4 py-3 text-slate-600 bg-slate-50 border-b border-slate-200";
      caption.textContent = captionText;

      table.appendChild(thead);
      table.appendChild(tbody);
      table.appendChild(totalRow);
      wrap.appendChild(caption);
      wrap.appendChild(table);
      return wrap;
    }

    // ----- Weekly / Monthly -----
    function renderWeekly() {
      const cls = weekClass.value;
      const { start, end } = getWeekRange(parseYMD(weekDate.value));
      const allToggle = document.getElementById('weekAllToggle');
      const showAll = allToggle && allToggle.checked;

      if (!showAll) {
        $("#weekRangeText").textContent = `${start.toLocaleDateString("id-ID")} s.d. ${end.toLocaleDateString("id-ID")} • ${cls}`;
        const ag = aggregateRange(cls, start, end);
        const wrap = $("#weeklyTableWrap");
        const allWrap = document.getElementById('weeklyAllWrap');
        wrap.innerHTML = "";
        if (allWrap) { allWrap.classList.add("hidden"); allWrap.innerHTML = ""; }
        wrap.appendChild(buildSummaryTable(ag, `Rentang Mingguan: ${start.toLocaleDateString("id-ID")} – ${end.toLocaleDateString("id-ID")}`));
        return;
      }

      // Semua kelas: gabungkan dan urutkan berdasarkan Asrama
      $("#weekRangeText").textContent = `${start.toLocaleDateString("id-ID")} s.d. ${end.toLocaleDateString("id-ID")} • Semua Kelas`;
      const allWrap = document.getElementById('weeklyAllWrap');
      const wrap = document.getElementById('weeklyTableWrap');
      wrap.innerHTML = "";
      allWrap.classList.remove('hidden');
      allWrap.innerHTML = "";

      const rows = [];
      CLASS_NAMES.forEach(kls => {
        const { counts, students } = aggregateRange(kls, start, end);
        students.forEach(s => {
          const c = counts[s.id];
          const hadir = c.HADIR; // Terlambat tidak ikut
          const pct = c.totalDays ? Math.round((hadir / c.totalDays) * 100) : 0;
          rows.push({
            dorm: (s.dorm || '').toLowerCase(),
            dormLabel: s.dorm || '-',
            name: s.name,
            kelas: kls,
            hadir: c.HADIR, izin: c.IZIN, sakit: c.SAKIT, alfa: c.ALFA, pct
          });
        });
      });

      rows.sort((a,b) => a.dorm.localeCompare(b.dorm) || a.name.localeCompare(b.name));

      const table = document.createElement('table');
      table.className = 'min-w-[720px] w-full text-sm text-slate-700';
      table.innerHTML = `
        <thead>
          <tr class="bg-slate-50 text-slate-600">
            <th class="text-left px-4 py-3 font-semibold">Asrama</th>
            <th class="text-left px-4 py-3 font-semibold">Siswa</th>
            <th class="px-4 py-3 font-semibold">Kelas</th>
            <th class="px-4 py-3 font-semibold">Hadir</th>
            <th class="px-4 py-3 font-semibold">Izin</th>
            <th class="px-4 py-3 font-semibold">Sakit</th>
            <th class="px-4 py-3 font-semibold">Alfa</th>
            <th class="px-4 py-3 font-semibold">Persentase</th>
          </tr>
        </thead>
        <tbody></tbody>`;
      const tbody = table.querySelector('tbody');

      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-slate-200';
        tr.innerHTML = `
          <td class="px-4 py-3">${r.dormLabel}</td>
          <td class="px-4 py-3 font-medium">${r.name}</td>
          <td class="px-4 py-3">${r.kelas}</td>
          <td class="px-4 py-3">${r.hadir}</td>
          <td class="px-4 py-3">${r.izin}</td>
          <td class="px-4 py-3">${r.sakit}</td>
          <td class="px-4 py-3">${r.alfa}</td>
          <td class="px-4 py-3">${r.pct}%</td>`;
        tbody.appendChild(tr);
      });

      const caption = document.createElement('div');
      caption.className = 'px-4 py-3 text-slate-600 bg-slate-50 border-b border-slate-200';
      caption.textContent = `Semua Kelas • Urut Asrama • Rentang: ${start.toLocaleDateString('id-ID')} – ${end.toLocaleDateString('id-ID')}`;

      allWrap.appendChild(caption);
      allWrap.appendChild(table);
    }

    function renderMonthly() {
      const cls = monthClass.value;
      const { start, end } = getMonthRange(monthInput.value);
      const monthName = start.toLocaleDateString("id-ID", { month: "long", year: "numeric" });
      $("#monthRangeText").textContent = `${monthName} • ${cls}`;
      const ag = aggregateRange(cls, start, end);
      const wrap = $("#monthlyTableWrap");
      wrap.innerHTML = "";
      wrap.appendChild(buildSummaryTable(ag, `Rentang Bulanan: ${monthName}`));
    }

    // ----- Export helpers -----
    function tableToExcel(filename, tableHtml) {
      const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office"
              xmlns:x="urn:schemas-microsoft-com:office:excel"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
            <x:Name>Sheet1</x:Name>
            <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
          </x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
          <meta charset="utf-8" />
        </head>
        <body>${tableHtml}</body>
        </html>`;
      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename.endsWith('.xls') ? filename : filename + '.xls'; document.body.appendChild(a); a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
    }

    // Buttons
    $("#printBtn").addEventListener("click", () => window.print());

    $("#exportExcelBtn").addEventListener("click", () => {
      const active = tabs.find(t => t.classList.contains("active"))?.dataset.tab;
      if (active === "mingguan") {
        const allToggle = document.getElementById('weekAllToggle');
        const showAll = allToggle && allToggle.checked;
        const { start, end } = getWeekRange(parseYMD(weekDate.value));
        if (showAll) {
          // Export all classes (urut asrama)
          const title = `Rekap Mingguan Semua Kelas (${start.toLocaleDateString("id-ID")} – ${end.toLocaleDateString("id-ID")})`;
          const table = document.createElement('table'); table.border = 1;
          const rows = [];
          CLASS_NAMES.forEach(kls => {
            const { counts, students } = aggregateRange(kls, start, end);
            students.forEach(s => {
              const c = counts[s.id];
              const hadir = c.HADIR;
              const pct = c.totalDays ? Math.round((hadir / c.totalDays) * 100) : 0;
              rows.push({ dorm: (s.dorm||'').toLowerCase(), dormLabel: s.dorm || '-', name: s.name, kelas: kls, HADIR:c.HADIR, IZIN:c.IZIN, SAKIT:c.SAKIT, ALFA:c.ALFA, pct });
            });
          });
          rows.sort((a,b) => a.dorm.localeCompare(b.dorm) || a.name.localeCompare(b.name));
          table.innerHTML = `<tr><th>Asrama</th><th>Siswa</th><th>Kelas</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Alfa</th><th>Persentase</th></tr>`;
          rows.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.dormLabel}</td><td>${r.name}</td><td>${r.kelas}</td><td>${r.HADIR}</td><td>${r.IZIN}</td><td>${r.SAKIT}</td><td>${r.ALFA}</td><td>${r.pct}%</td>`;
            table.appendChild(tr);
          });
          tableToExcel(`${title}.xls`, `<h3>${title}</h3>` + table.outerHTML);
        } else {
          // Export selected class weekly
          const cls = weekClass.value;
          const ag = aggregateRange(cls, start, end);
          const title = `Rekap Mingguan ${cls} (${start.toLocaleDateString("id-ID")} – ${end.toLocaleDateString("id-ID")})`;
          const table = document.createElement('table'); table.border = 1;
          table.innerHTML = `<tr><th>Siswa</th><th>Asrama</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Alfa</th><th>Persentase</th></tr>`;
          ag.students.forEach(s => { const c = ag.counts[s.id]; const hadir = c.HADIR; const pct = c.totalDays ? Math.round((hadir/c.totalDays)*100) : 0;
            const tr = document.createElement('tr'); tr.innerHTML = `<td>${s.name}</td><td>${s.dorm || '-'}</td><td>${c.HADIR}</td><td>${c.IZIN}</td><td>${c.SAKIT}</td><td>${c.ALFA}</td><td>${pct}%</td>`; table.appendChild(tr); });
          tableToExcel(`${title}.xls`, `<h3>${title}</h3>` + table.outerHTML);
        }
      } else if (active === "bulanan") {
        const cls = monthClass.value; const { start } = getMonthRange(monthInput.value); const end = new Date(start.getFullYear(), start.getMonth()+1, 0); const ag = aggregateRange(cls, start, end);
        const monthName = start.toLocaleDateString("id-ID", { month: "long", year: "numeric" }); const title = `Rekap Bulanan ${cls} (${monthName})`;
        const table = document.createElement('table'); table.border = 1;
        table.innerHTML = `<tr><th>Siswa</th><th>Asrama</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Alfa</th><th>Persentase</th></tr>`;
        ag.students.forEach(s => { const c = ag.counts[s.id]; const hadir = c.HADIR; const pct = c.totalDays ? Math.round((hadir/c.totalDays)*100) : 0;
          const tr = document.createElement('tr'); tr.innerHTML = `<td>${s.name}</td><td>${s.dorm || '-'}</td><td>${c.HADIR}</td><td>${c.IZIN}</td><td>${c.SAKIT}</td><td>${c.ALFA}</td><td>${pct}%</td>`; table.appendChild(tr); });
        tableToExcel(`${title}.xls`, `<h3>${title}</h3>` + table.outerHTML);
      } else {
        const cls = classSelect.value; const dayKey = dateInput.value; const store = loadStore(); const data = store[dayKey]?.[cls] || {}; const students = STUDENTS[cls] || [];
        const title = `Absensi Harian ${cls} (${dayKey})`; const table = document.createElement('table'); table.border = 1;
        table.innerHTML = `<tr><th>Siswa</th><th>Status</th><th>Tanggal</th><th>Kelas</th><th>Asrama</th></tr>`;
        students.forEach(s => { const st = data[s.id]?.status ? STATUS_LABEL[data[s.id].status] : '-'; const tr = document.createElement('tr'); tr.innerHTML = `<td>${s.name}</td><td>${st}</td><td>${dayKey}</td><td>${cls}</td><td>${s.dorm || '-'}</td>`; table.appendChild(tr); });
        tableToExcel(`${title}.xls`, `<h3>${title}</h3>` + table.outerHTML);
      }
    });

    // Import helpers
    function normalizeHeader(h) {
      const k = String(h || "").trim().toLowerCase();
      if (["kelas","class","grade"].includes(k)) return "kelas";
      if (["nama","siswa","name","student"].includes(k)) return "nama";
      if (["asrama","dorm","dormitory"].includes(k)) return "asrama";
      if (["id","kode","nim"].includes(k)) return "id";
      return k;
    }
    function normalizeClassName(v) {
      const raw = String(v || "").toUpperCase().replace(/\s+/g,' ').trim();
      if (CLASS_MAP[raw]) return CLASS_MAP[raw];
      const compact = raw.replace(/^KELAS\s+/,'').replace(/\s+/g,' ').trim();
      const tries = [ `KELAS ${compact}`, compact ];
      for (const t of tries) {
        const key = t.toUpperCase().replace(/\s+/g,' ').trim();
        if (CLASS_MAP[key]) return CLASS_MAP[key];
      }
      return null;
    }
    function splitCSVLine(line) {
      const out = []; let cur = ""; let q = false;
      for (let i=0; i<line.length; i++) {
        const ch = line[i];
        if (ch === '"') { if (q && line[i+1] === '"') { cur += '"'; i++; } else { q = !q; } }
        else if (ch === ',' && !q) { out.push(cur); cur = ""; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length === 0) return [];
      const headers = splitCSVLine(lines[0]).map(normalizeHeader);
      const rows = [];
      for (let i=1; i<lines.length; i++) {
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (cols[idx] || "").trim());
        rows.push(obj);
      }
      return rows;
    }
    function parseXLS_HTML(text) {
      const doc = new DOMParser().parseFromString(text, "text/html");
      const table = doc.querySelector("table");
      if (!table) return [];
      const trs = Array.from(table.querySelectorAll("tr"));
      if (trs.length === 0) return [];
      const headCells = Array.from(trs[0].querySelectorAll("th,td")).map(c => normalizeHeader(c.textContent));
      const rows = [];
      for (let i=1; i<trs.length; i++) {
        const cells = Array.from(trs[i].querySelectorAll("td,th"));
        if (cells.length === 0) continue;
        const obj = {};
        headCells.forEach((h, idx) => obj[h] = (cells[idx]?.textContent || "").trim());
        rows.push(obj);
      }
      return rows;
    }
    function buildIdForClass(cls, idx) {
      const num = cls.match(/\d+/)?.[0] || "0";
      return `${num}-${idx}`;
    }

    // Add Student submit
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('addStudentForm');
      if (!form) return;
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const cls = document.getElementById('addClass').value;
        const name = document.getElementById('addName').value.trim();
        const dorm = document.getElementById('addDorm').value.trim();
        let id = document.getElementById('addId').value.trim();
        if (!cls || !name) { showToast('Isi kelas dan nama', 'error'); return; }
        const list = STUDENTS[cls] || [];
        if (!id) { id = buildIdForClass(cls, list.length + 1); }
        if (list.some(s => s.id === id)) {
          let i = list.length + 1;
          while (list.some(s => s.id === `${id}-${i}`)) i++;
          id = `${id}-${i}`;
        }
        const newEntry = { id, name, dorm };
        STUDENTS[cls] = [...list, newEntry];
        saveStudentsData(STUDENTS);
        renderDaily(); renderWeekly(); renderMonthly();
        showToast('Siswa ditambahkan');
        document.getElementById('addStudentModal').classList.add('hidden');
        document.getElementById('addStudentModal').classList.remove('flex');
      });
    });

    // Import modal helpers
    function openModal() { importModal.classList.remove("hidden"); importModal.classList.add("flex"); }
    function closeModal() { importModal.classList.add("hidden"); importModal.classList.remove("flex"); }
    closeModalBtn.addEventListener("click", closeModal);
    cancelImportBtn.addEventListener("click", closeModal);

    document.getElementById('closeAddModal').addEventListener('click', () => {
      document.getElementById('addStudentModal').classList.add('hidden');
      document.getElementById('addStudentModal').classList.remove('flex');
    });
    document.getElementById('cancelAdd').addEventListener('click', () => {
      document.getElementById('addStudentModal').classList.add('hidden');
      document.getElementById('addStudentModal').classList.remove('flex');
    });

    // Edit modal helpers
    function openEditModal(currentClass, student) {
      const modal = document.getElementById('editStudentModal');
      const sel = document.getElementById('editClass');
      sel.innerHTML = '';
      CLASS_NAMES.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
      sel.value = currentClass;
      document.getElementById('editOriginalClass').value = currentClass;
      document.getElementById('editOriginalId').value = student.id;
      document.getElementById('editName').value = student.name || '';
      document.getElementById('editDorm').value = student.dorm || '';
      document.getElementById('editId').value = student.id || '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function closeEditModal() { const modal = document.getElementById('editStudentModal'); modal.classList.add('hidden'); modal.classList.remove('flex'); }
    document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
    document.getElementById('cancelEdit').addEventListener('click', closeEditModal);

    // Edit submit & delete
    document.getElementById('editStudentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const originalClass = document.getElementById('editOriginalClass').value;
      const originalId = document.getElementById('editOriginalId').value;
      const newClass = document.getElementById('editClass').value;
      const name = document.getElementById('editName').value.trim();
      const dorm = document.getElementById('editDorm').value.trim();
      let id = document.getElementById('editId').value.trim();
      if (!name) { showToast('Nama tidak boleh kosong', 'error'); return; }

      const origList = STUDENTS[originalClass] || [];
      const rest = origList.filter(s => s.id !== originalId);
      const newList = (STUDENTS[newClass] || []).slice();

      if (!id) { id = buildIdForClass(newClass, newList.length + 1); }
      if (newList.some(s => s.id === id)) {
        let i = newList.length + 1;
        while (newList.some(s => s.id === `${id}-${i}`)) i++;
        id = `${id}-${i}`;
      }

      STUDENTS[originalClass] = rest;
      newList.push({ id, name, dorm });
      STUDENTS[newClass] = newList;

      saveStudentsData(STUDENTS);
      renderDaily(); renderWeekly(); renderMonthly();
      showToast('Perubahan disimpan');
      closeEditModal();
    });

    document.getElementById('deleteStudent').addEventListener('click', () => {
      const originalClass = document.getElementById('editOriginalClass').value;
      const originalId = document.getElementById('editOriginalId').value;
      const list = STUDENTS[originalClass] || [];
      STUDENTS[originalClass] = list.filter(s => s.id !== originalId);
      saveStudentsData(STUDENTS);
      renderDaily(); renderWeekly(); renderMonthly();
      showToast('Siswa dihapus');
      closeEditModal();
    });

    // Import flow
    function preparePreview(rows) {
      const preview = [];
      const errors = [];
      const idSeenPerClass = {};
      rows.forEach((r, idx) => {
        const rowNum = idx + 2;
        const cls = normalizeClassName(r.kelas);
        const nama = (r.nama || "").trim();
        const asrama = (r.asrama || "").trim();
        let id = (r.id || "").trim();
        const issues = [];
        if (!cls) issues.push("Kelas tidak dikenal");
        if (!nama) issues.push("Nama kosong");
        if (cls) {
          idSeenPerClass[cls] = idSeenPerClass[cls] || new Set();
          if (id) {
            if (idSeenPerClass[cls].has(id)) { issues.push("ID duplikat (file)"); }
            else idSeenPerClass[cls].add(id);
          }
        }
        preview.push({ rowNum, kelas: r.kelas || "", kelasNorm: cls, nama, asrama, id, issues });
        if (issues.length) errors.push({ rowNum, issues, nama, kelas: r.kelas });
      });
      return { preview, errors };
    }

    function renderPreviewUI(preview, errors) {
      importTableBody.innerHTML = "";
      const limit = 200;
      preview.slice(0, limit).forEach(p => {
        const tr = document.createElement("tr");
        const ok = p.kelasNorm && p.nama && p.issues.length === 0;
        tr.className = "border-t " + (ok ? "border-slate-200" : "border-rose-200 bg-rose-50");
        const statusTxt = ok ? "OK" : p.issues.join(", ");
        tr.innerHTML = `
          <td class="px-3 py-2">${p.kelasNorm || p.kelas || "-"}</td>
          <td class="px-3 py-2">${p.nama || "-"}</td>
          <td class="px-3 py-2">${p.asrama || "-"}</td>
          <td class="px-3 py-2">${p.id || "-"}</td>
          <td class="px-3 py-2 ${ok ? 'text-emerald-600' : 'text-rose-700'}">${statusTxt}</td>`;
        importTableBody.appendChild(tr);
      });
      if (preview.length > limit) {
        importMoreNote.classList.remove("hidden");
        importMoreNote.textContent = `Menampilkan ${limit} dari ${preview.length} baris... (semua baris tetap akan diproses saat impor)`;
      } else {
        importMoreNote.classList.add("hidden");
      }

      const okCount = preview.filter(p => p.kelasNorm && p.nama && p.issues.length === 0).length;
      const warnCount = preview.length - okCount;
      importSummary.textContent = `Baris terbaca: ${preview.length}. Siap diimpor: ${okCount}. Perlu perhatian: ${warnCount}.`;
      if (errors.length) {
        importErrors.classList.remove("hidden");
        const list = errors.slice(0, 10).map(e => `Baris ${e.rowNum}: ${e.issues.join(", ")}`).join(" • ");
        importErrors.textContent = `Catatan: ${list}${errors.length > 10 ? " ...": ""}`;
      } else {
        importErrors.classList.add("hidden");
      }
    }

    function importStudentsFromPreview(preview) {
      const groups = {};
      let total = 0;
      preview.forEach((p) => {
        if (!(p.kelasNorm && p.nama)) return;
        const cls = p.kelasNorm;
        if (!groups[cls]) groups[cls] = [];
        groups[cls].push({ id: p.id, name: p.nama, dorm: p.asrama });
      });
      if (Object.keys(groups).length === 0) { showToast("Tidak ada baris valid untuk diimpor", "error"); return; }

      const newData = JSON.parse(JSON.stringify(STUDENTS));
      Object.keys(groups).forEach(cls => {
        const seen = new Set();
        const arr = groups[cls].map((item, idx) => {
          let id = (item.id || "").trim();
          if (!id) id = buildIdForClass(cls, idx + 1);
          if (seen.has(id)) {
            let suffix = 2;
            while (seen.has(id + "-" + suffix)) suffix++;
            id = id + "-" + suffix;
          }
          seen.add(id);
          return { id, name: item.name, dorm: item.dorm || "" };
        });
        newData[cls] = arr;
        total += arr.length;
      });
      STUDENTS = newData;
      saveStudentsData(newData);
      populateClassSelects();
      renderDaily(); renderWeekly(); renderMonthly();
      showToast(`Impor berhasil: ${total} siswa diperbarui.`);
    }

    importBtn.addEventListener("click", () => importFile.click());
    addStudentBtn.addEventListener("click", () => {
      const sel = document.getElementById('addClass');
      sel.innerHTML = '';
      CLASS_NAMES.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o); });
      sel.value = classSelect.value;
      document.getElementById('addName').value = '';
      document.getElementById('addDorm').value = '';
      document.getElementById('addId').value = '';
      document.getElementById('addStudentModal').classList.remove('hidden');
      document.getElementById('addStudentModal').classList.add('flex');
    });
    importFile.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const ext = (file.name.split(".").pop() || "").toLowerCase();
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = String(reader.result || "");
          let rows = [];
          if (ext === "csv") rows = parseCSV(text);
          else if (ext === "xls") rows = parseXLS_HTML(text);
          else rows = parseCSV(text);
          const { preview, errors } = preparePreview(rows);
          _previewRows = preview;
          renderPreviewUI(preview, errors);
          openModal();
        } catch {
          showToast("Gagal membaca file. Pastikan format benar.", "error");
        } finally { importFile.value = ""; }
      };
      reader.onerror = () => { showToast("Gagal membuka file", "error"); importFile.value = ""; };
      reader.readAsText(file);
    });
    confirmImportBtn.addEventListener("click", () => { importStudentsFromPreview(_previewRows); closeModal(); });

    // Tabs
    function updateTabActive(key) {
      tabs.forEach(t => {
        const active = t.dataset.tab === key;
        t.classList.toggle("bg-white", active);
        t.classList.toggle("text-slate-900", active);
        t.classList.toggle("shadow", active);
        t.classList.toggle("active", active);
      });
      $("#tab-harian").classList.toggle("hidden", key !== "harian");
      $("#tab-mingguan").classList.toggle("hidden", key !== "mingguan");
      $("#tab-bulanan").classList.toggle("hidden", key !== "bulanan");
    }

    // Events
    document.addEventListener("submit", (e) => e.preventDefault());
    classSelect.addEventListener("change", renderDaily);
    dateInput.addEventListener("change", renderDaily);
    $("#saveDaily").addEventListener("click", (e) => { e.preventDefault(); saveDaily(); });
    $("#markAllPresent").addEventListener("click", () => markAll("HADIR"));
    $("#markAllAlpha").addEventListener("click", () => markAll("ALFA"));
    $("#clearDay").addEventListener("click", () => clearDay());

    weekDate.addEventListener("change", renderWeekly);
    weekClass.addEventListener("change", renderWeekly);
    const weekAllToggle = document.getElementById('weekAllToggle');
    if (weekAllToggle) weekAllToggle.addEventListener('change', renderWeekly);

    monthInput.addEventListener("change", renderMonthly);
    monthClass.addEventListener("change", renderMonthly);

    tabs.forEach(b => b.addEventListener("click", () => {
      updateTabActive(b.dataset.tab);
      if (b.dataset.tab === "mingguan") renderWeekly();
      if (b.dataset.tab === "bulanan") renderMonthly();
    }));

    // Template Excel
    downloadTemplateBtn.addEventListener("click", () => {
      const allowed = CLASS_NAMES.join(", ");
      const guide = `
        <table border="1">
          <tr><th colspan="2">Petunjuk</th></tr>
          <tr><td>Kolom</td><td>Keterangan</td></tr>
          <tr><td>Kelas</td><td>Isi salah satu dari: ${allowed}</td></tr>
          <tr><td>Nama</td><td>Nama lengkap siswa</td></tr>
          <tr><td>Asrama</td><td>Nama asrama (boleh kosong)</td></tr>
          <tr><td>ID</td><td>Boleh dikosongkan, akan dibuat otomatis jika tidak diisi</td></tr>
          <tr><td colspan="2">Simpan sebagai .xls (HTML) atau .csv untuk impor.</td></tr>
        </table>`;

      const rows = [["Kelas","Nama","Asrama","ID"]];
      CLASS_NAMES.forEach((c, i) => {
        rows.push([c, `Contoh Siswa ${i+1}`, i % 2 ? "Asrama B" : "Asrama A", ""]);
      });
      const table = document.createElement('table');
      table.border = 1;
      rows.forEach(r => {
        const tr = document.createElement('tr');
        r.forEach(c => { const td = document.createElement('td'); td.textContent = c; tr.appendChild(td); });
        table.appendChild(tr);
      });

      const htmlCombined = `
        <div><h3>Petunjuk</h3>${guide}</div>
        <div style="margin-top:16px"><h3>DataSiswa</h3>${table.outerHTML}</div>`;
      tableToExcel("Template-Data-Siswa.xls", htmlCombined);
    });

    // Init
    defaultInit();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984361e880169d6f',t:'MTc1ODcyODQ1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
